rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Global helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Admin role is determined by a custom claim set securely on the server.
    function isAdmin() {
      return request.auth.token.admin == true;
    }
    
    // A staff member has an adminId claim pointing to their administrator.
    function isStaffOf(adminId) {
        return request.auth.token.adminId == adminId;
    }

    // Rules for the user collection
    match /users/{userId} {
      // Any authenticated user can read any user profile (e.g., for display names).
      allow get: if isSignedIn();
      
      // Users can only create their own profile.
      // They cannot assign their own role; this is handled by the server.
      allow create: if isOwner(userId) && request.resource.data.role != 'admin';
      
      // Users can update their own profile, but cannot change their role.
      allow update: if isOwner(userId) && request.resource.data.role == resource.data.role;
    }

    // Rules for all data scoped under an admin
    match /admins/{adminId} {
        // Only the admin owner can read/write directly to their own admin document space.
        allow read, write: if isOwner(adminId);

        // Rules for patients collection, owned by an admin
        match /patients/{patientId} {
            // Admin can do anything.
            // Staff belonging to this admin can read patient lists and individual patient data.
            allow get, list: if isOwner(adminId) || isStaffOf(adminId);
            allow create, update, delete: if isOwner(adminId);

            // Rules for daily records subcollection
            match /dailyRecords/{recordId} {
                // Admin can do anything.
                // Staff of this admin can read records.
                allow get, list: if isOwner(adminId) || isStaffOf(adminId);
                // Staff can create records for patients they are assigned to.
                allow create: if isStaffOf(adminId);
                // Only admin can update/delete records for now.
                allow update, delete: if isOwner(adminId);
            }
            
            // Rules for sleep logs subcollection
            match /sleepLogs/{sleepLogId} {
               allow read, write: if isOwner(adminId) || isStaffOf(adminId);
            }
        }
        
        // Rules for staff collection, owned by an admin
        match /staff/{staffId} {
            // Admin can manage their own staff.
            // Other staff members can see who is on their team.
            allow get, list: if isOwner(adminId) || isStaffOf(adminId);
            allow create, update, delete: if isOwner(adminId);
        }
    }
  }
}
